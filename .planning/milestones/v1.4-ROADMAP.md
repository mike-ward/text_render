# Milestone v1.4: CJK IME

**Status:** ✅ SHIPPED 2026-02-04
**Phases:** 18-21
**Total Plans:** 9

## Overview

Full CJK input method support via overlay NSView without sokol modifications. Japanese and Chinese
IME fully working, Korean has known macOS first-keypress bug (reported upstream).

## Phases

### Phase 18: Overlay Infrastructure

**Goal**: Native IME bridge exists and can become first responder
**Depends on**: Phase 17 (v1.3 foundation)
**Plans**: 1 plan

Plans:
- [x] 18-01: VGlyphIMEOverlayView class with NSTextInputClient stubs, factory API, focus management

**Details:**
- VGlyphIMEOverlayView as sibling above MTKView (not child)
- Auto Layout constraints bind overlay to MTKView bounds
- Click pass-through via hitTest: nil
- ARC memory management with __bridge_retained

### Phase 19: NSTextInputClient Protocol + Japanese/Chinese

**Goal**: IME events flow from overlay to CompositionState, Japanese and Chinese input works
**Depends on**: Phase 18
**Plans**: 3 plans

Plans:
- [x] 19-01: setMarkedText, insertText, unmarkText with C callbacks
- [x] 19-02: firstRectForCharacterRange with coordinate transform, clause attribute parsing
- [x] 19-03: V-side callback handlers and draw_composition rendering

**Details:**
- Per-overlay callbacks (not global) for multiple text fields
- Clause style mapping: 2=selected (thick underline), 1=converted, else=raw
- Y-flip formula: self.bounds.size.height - y - h for macOS origin

### Phase 20: Korean + Keyboard Integration

**Goal**: Korean hangul composition works, keyboard edge cases handled
**Depends on**: Phase 19
**Plans**: 2 plans

Plans:
- [x] 20-01: Native overlay key forwarding, focus loss handling, IME state cleanup
- [x] 20-02: Undo/redo blocking, Option+Backspace cancels, Cmd+A commits

**Details:**
- keyDown forwards to interpretKeyEvents during composition
- Escape handled via cancelOperation:
- Composition guard pattern for keyboard operations

**Known Issue:** Korean first-keypress fails (macOS-level bug).

### Phase 21: Multi-Display & Polish

**Goal**: CJK IME works correctly on multi-monitor and Retina setups
**Depends on**: Phase 20
**Plans**: 3 plans

Plans:
- [x] 21-01: Fix multi-monitor coordinate handling (convertRectToScreen)
- [x] 21-02: Korean IME workarounds (pre-warm, discardMarkedText, handleEvent-first)
- [x] 21-03: End-to-end CJK IME verification checkpoint

**Details:**
- NSZeroRect fallback on coordinate failure
- Korean workarounds attempted but first-keypress still fails

---

## Milestone Summary

**Decimal Phases:** None

**Key Decisions:**
- Overlay sibling positioning (avoid Metal conflicts) — Phase 18
- Per-overlay callbacks for multi-field support — Phase 19
- Thick underline = selected clause (style 2) — Phase 19
- Block undo/redo during composition — Phase 20
- Option+Backspace cancels (discards preedit) — Phase 20
- NSZeroRect fallback on coordinate failure — Phase 21

**Issues Resolved:**
- CJK IME support without sokol modifications (overlay architecture)
- Multi-monitor candidate window positioning (convertRectToScreen)
- Retina coordinate handling (backing scale factor automatic)

**Issues Deferred:**
- Korean first-keypress (macOS-level bug, reported upstream)
- Multi-field overlay API (pending gg native handle access)

**Technical Debt Incurred:**
- Global callback API still used (overlay API commented pending native handle)
- Korean IME requires user workaround (type first char twice)

---

*For current project status, see .planning/ROADMAP.md*
