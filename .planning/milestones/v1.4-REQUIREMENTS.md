# Requirements Archive: v1.4 CJK IME

**Archived:** 2026-02-04
**Status:** ✅ SHIPPED (PARTIAL - Korean first-keypress known issue)

This is the archived requirements specification for v1.4.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: VGlyph v1.4 CJK IME

**Defined:** 2026-02-03
**Core Value:** Full CJK input method support without sokol modifications

## v1.4 Requirements

Requirements for CJK IME milestone. Each maps to roadmap phases.

### Overlay Infrastructure

- [x] **OVLY-01**: VGlyphIMEOverlayView class implementing NSTextInputClient protocol
- [x] **OVLY-02**: Overlay positioned above MTKView as sibling (not child)
- [x] **OVLY-03**: Overlay activates as first responder when text field focused
- [x] **OVLY-04**: Overlay deactivates and returns first responder to MTKView on blur
- [x] **OVLY-05**: Non-Darwin stub implementation (no-op functions)

### NSTextInputClient Protocol

- [x] **PROT-01**: setMarkedText:selectedRange:replacementRange: forwards to CompositionState
- [x] **PROT-02**: insertText:replacementRange: commits text and inserts at cursor
- [x] **PROT-03**: markedRange returns current composition byte range
- [x] **PROT-04**: selectedRange returns cursor position within composition
- [x] **PROT-05**: hasMarkedText returns true when composition active
- [x] **PROT-06**: unmarkText cancels composition (auto-commit on focus loss)
- [x] **PROT-07**: firstRectForCharacterRange:actualRange: returns screen coordinates
- [x] **PROT-08**: validAttributesForMarkedText returns supported underline styles

### Japanese IME

- [x] **JPIM-01**: Hiragana preedit displayed with underline during romaji→hiragana conversion
- [x] **JPIM-02**: Clause segmentation visible (multiple underlined segments)
- [x] **JPIM-03**: Space key triggers kanji conversion (shows candidate window)
- [x] **JPIM-04**: Enter key commits selected candidate
- [x] **JPIM-05**: Escape key cancels composition
- [x] **JPIM-06**: Arrow keys navigate between clauses
- [x] **JPIM-07**: Selected clause indicated by thick underline

### Chinese IME

- [x] **CHIM-01**: Pinyin preedit displayed with underline during typing
- [x] **CHIM-02**: Candidate window appears near cursor (via firstRectForCharacterRange)
- [x] **CHIM-03**: Number keys (1-9) select candidate directly
- [x] **CHIM-04**: Space key selects first candidate
- [x] **CHIM-05**: Enter key commits typed pinyin as-is (if no candidate selected)

### Korean IME

- [x] **KRIM-01**: Jamo composition displayed (ㄱ + ㅏ = 가) in real-time
- [x] **KRIM-02**: Backspace decomposes syllable (간 → 가 → ㄱ → empty)
- [x] **KRIM-03**: Space/punctuation commits current syllable
- [~] **KRIM-04**: Single syllable preedit underlined during composition (first-keypress issue*)

### Keyboard Integration

- [x] **KEYB-01**: Backspace forwarded to IME when hasMarkedText is true
- [x] **KEYB-02**: Dead key composition works after using CJK IME
- [x] **KEYB-03**: Focus loss auto-commits preedit (not lost)
- [x] **KEYB-04**: Undo/redo blocked when hasMarkedText is true

### Multi-Display Support

- [x] **DISP-01**: Candidate window appears on correct monitor
- [x] **DISP-02**: Coordinate transforms work with Retina displays (backing scale factor)

## Future Requirements

Deferred to post-v1.4. Tracked but not in current roadmap.

### Advanced IME

- **ADVN-01**: Reconversion (select committed text, convert again)
- **ADVN-02**: Hanja conversion (Korean → Chinese characters)
- **ADVN-03**: Vertical text candidate window positioning
- **ADVN-04**: Custom keyboard layouts

### Cross-Platform

- **XPLT-01**: Linux IME support (IBus/Fcitx)
- **XPLT-02**: Windows IME support (TSF)

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Custom IME implementation | Use system IME, don't reinvent |
| Dictionary management | System IME handles |
| Prediction/autocomplete | System IME feature |
| IME switching UI | System handles (Cmd+Space) |
| Handwriting recognition | Separate system feature |
| Voice input | Separate dictation system |
| Sokol modifications | Project constraint |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| OVLY-01 | Phase 18 | Complete |
| OVLY-02 | Phase 18 | Complete |
| OVLY-03 | Phase 18 | Complete |
| OVLY-04 | Phase 18 | Complete |
| OVLY-05 | Phase 18 | Complete |
| PROT-01 | Phase 19 | Complete |
| PROT-02 | Phase 19 | Complete |
| PROT-03 | Phase 19 | Complete |
| PROT-04 | Phase 19 | Complete |
| PROT-05 | Phase 19 | Complete |
| PROT-06 | Phase 19 | Complete |
| PROT-07 | Phase 19 | Complete |
| PROT-08 | Phase 19 | Complete |
| JPIM-01 | Phase 19 | Complete |
| JPIM-02 | Phase 19 | Complete |
| JPIM-03 | Phase 19 | Complete |
| JPIM-04 | Phase 19 | Complete |
| JPIM-05 | Phase 19 | Complete |
| JPIM-06 | Phase 19 | Complete |
| JPIM-07 | Phase 19 | Complete |
| CHIM-01 | Phase 19 | Complete |
| CHIM-02 | Phase 19 | Complete |
| CHIM-03 | Phase 19 | Complete |
| CHIM-04 | Phase 19 | Complete |
| CHIM-05 | Phase 19 | Complete |
| KRIM-01 | Phase 20 | Complete |
| KRIM-02 | Phase 20 | Complete |
| KRIM-03 | Phase 20 | Complete |
| KRIM-04 | Phase 20 | Partial* |
| KEYB-01 | Phase 20 | Complete |
| KEYB-02 | Phase 20 | Complete |
| KEYB-03 | Phase 20 | Complete |
| KEYB-04 | Phase 20 | Complete |
| DISP-01 | Phase 21 | Complete |
| DISP-02 | Phase 21 | Complete |

---

## Milestone Summary

**Shipped:** 33 of 34 v1.4 requirements
**Adjusted:** None
**Dropped:** None
**Partial:** 1 (KRIM-04 - Korean first-keypress is macOS-level bug)

---
*Archived: 2026-02-04 as part of v1.4 milestone completion*
