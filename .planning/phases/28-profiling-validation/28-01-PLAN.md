---
phase: 28-profiling-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/stress_validation.v
autonomous: true

must_haves:
  truths:
    - "stress_validation example compiles and runs with -d profile"
    - "Profile output shows LayoutCache hit rate percentage"
    - "Profile output shows atlas utilization percentage"
    - "Profile output shows upload time in microseconds"
    - "Async vs sync comparison produces measurable difference"
    - "P29 recommendation written to VERIFICATION.md with rationale"
  artifacts:
    - path: "examples/stress_validation.v"
      provides: "Multilingual stress test with 2000+ glyphs"
      min_lines: 80
  key_links:
    - from: "examples/stress_validation.v"
      to: "context.v ProfileMetrics"
      via: "get_profile_metrics() + print_summary()"
      pattern: "get_profile_metrics.*print_summary"
    - from: "examples/stress_validation.v"
      to: "glyph_atlas.v async_uploads"
      via: "kill switch toggle for before/after"
      pattern: "async_uploads"
---

<objective>
Create multilingual stress test, measure P26/P27 optimization impact,
and make data-driven P29 go/no-go decision.

Purpose: Validate shelf packing and async upload improvements with
diverse multilingual workload. Decide whether shape caching (P29)
is needed based on LayoutCache hit rate.

Output: stress_validation.v example + profiling report in
VERIFICATION.md with P29 recommendation.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-profiling-validation/28-CONTEXT.md
@.planning/phases/28-profiling-validation/28-RESEARCH.md
@context.v (ProfileMetrics struct L56-135, print_summary(), layout_cache_hit_rate())
@api.v (TextSystem.get_profile_metrics() L521-554, reset_profile_metrics() L557-574)
@glyph_atlas.v (async_uploads kill switch L73)
@renderer.v (commit() async/sync paths L105-135)
@examples/stress_demo.v (existing stress test pattern)
@examples/atlas_debug.v (existing debug example pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multilingual stress test example</name>
  <files>examples/stress_validation.v</files>
  <action>
Create standalone stress test example following existing example patterns
(stress_demo.v, atlas_debug.v). The example must:

1. Module main, import gg + vglyph + time
2. App struct with gg.Context, TextSystem, frame counter, and a bool
   `measurements_printed` to print metrics exactly once
3. Multilingual text content spanning 2000+ unique glyphs:
   - ASCII: full printable range (0x21-0x7E, ~94 chars)
   - Latin Extended: accented chars (0xC0-0xFF, ~64 chars)
   - CJK: common ideographs (0x4E00-0x4FFF, ~256 chars selected)
   - Hangul: syllables (0xAC00-0xAC80, ~128 chars)
   - Emoji: diverse set (~30 emoji via string literals)
   - Greek/Cyrillic: (0x0391-0x03C9, 0x0410-0x044F, ~100 chars)
   - Arabic: (0x0621-0x064A, ~40 chars)
   - Devanagari: (0x0901-0x0939, ~50 chars)
   Total target: ~2000+ unique glyphs across 8+ scripts

4. Use two font sizes (20pt, 14pt) to increase atlas diversity
5. Render all content each frame in a grid layout
6. After 100 frames of warmup:
   - Call get_profile_metrics() and print_summary()
   - Print additional line: "LayoutCache hit rate: XX.X%"
   - Print additional line: "Atlas utilization: XX.X%"
   - Print additional line: "Upload time: XXX us"
   - Set measurements_printed = true, then exit (sapp.request_quit)

7. The example runs headless-ish: renders 100+ frames then auto-quits
   with metrics printed to stdout

Pattern notes:
- Use `$if profile ?` guard around get_profile_metrics calls
- Follow frame_fn/init_fn pattern from stress_demo.v
- Access async_uploads via ts.renderer is not public; instead the
  comparison will be done by running the binary twice (once default
  async, once with a compile-time or runtime flag). Since
  async_uploads is `pub mut` on GlyphAtlas but GlyphAtlas is accessed
  through Renderer which is not pub on TextSystem, the simplest
  approach: add a small pub method `set_async_uploads(enabled bool)`
  on TextSystem that forwards to renderer.atlas.async_uploads.
  Place it inside a `$if profile ?` block since it's only for
  profiling. Actually, check if renderer is pub mut on TextSystem -
  it's `mut` not `pub mut`. So add the setter method.

Wait - re-reading api.v: renderer is `mut:` (private mutable).
Add this method to api.v inside `$if profile ?`:

```v
pub fn (mut ts TextSystem) set_async_uploads(enabled bool) {
    ts.renderer.atlas.async_uploads = enabled
}
```

Then stress_validation.v can run two measurement passes:
  Pass 1 (frames 0-99): warmup with async (default)
  Pass 2 (frames 100-199): reset metrics, measure with async=true
  Pass 3 (frames 200-299): reset metrics, set async=false, measure sync
  Print both results at frame 300, then quit.

This gives a clean async vs sync comparison in a single run.

Format with: v fmt -w examples/stress_validation.v
Check syntax: v -check-syntax examples/stress_validation.v
  </action>
  <verify>
v -d profile -check-syntax examples/stress_validation.v succeeds.
v fmt -w examples/stress_validation.v produces no changes.
v -d profile run examples/stress_validation.v runs and prints profile
metrics to stdout, then exits.
  </verify>
  <done>
stress_validation.v compiles with -d profile, renders 2000+ multilingual
glyphs, prints LayoutCache hit rate / atlas utilization / upload time
for both async and sync modes, then auto-exits.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run profiling and write P29 recommendation</name>
  <files>api.v</files>
  <action>
1. Add set_async_uploads method to api.v inside `$if profile ?` block:

```v
// set_async_uploads toggles async texture upload mode (profiling only).
pub fn (mut ts TextSystem) set_async_uploads(enabled bool) {
    ts.renderer.atlas.async_uploads = enabled
}
```

Format: v fmt -w api.v

2. Run stress_validation.v with -d profile, capture stdout output.
   Parse the metrics from the output.

3. Write profiling report. The report goes into VERIFICATION.md in
   the phase directory. Include:
   - Raw metrics from both async and sync runs
   - LayoutCache hit rate analysis (the key P29 decision metric)
   - Atlas utilization analysis (validates shelf packing improvement)
   - Upload time comparison (validates async upload improvement)
   - P29 recommendation paragraph with rationale:
     * If LayoutCache hit rate >= 70%: recommend SKIP P29
       (cache is effective enough, shape caching adds complexity
       for marginal gain)
     * If LayoutCache hit rate < 70%: recommend PROCEED with P29
     * Include the actual threshold used and why

4. Update ROADMAP.md Phase 29 section based on recommendation.
   If skip: mark P29 as "Skipped - LayoutCache hit rate XX% >= 70%"
   and note v1.6 completes at P28.
   If proceed: leave P29 as-is.

Note: The 70% threshold is a guideline per CONTEXT.md. Use judgment
based on the actual numbers. If hit rate is 68% but trending up with
realistic workloads, might still recommend skip. Write the reasoning.
  </action>
  <verify>
VERIFICATION.md exists in .planning/phases/28-profiling-validation/
with profiling data and P29 recommendation.
ROADMAP.md updated if P29 is skipped.
  </verify>
  <done>
Profiling report documents LayoutCache hit rate, atlas utilization,
and upload time improvements. P29 go/no-go decision made with
written rationale. ROADMAP.md reflects decision.
  </done>
</task>

</tasks>

<verification>
1. `v -d profile -check-syntax examples/stress_validation.v` passes
2. `v -d profile run examples/stress_validation.v` prints profile
   metrics and exits cleanly
3. Profile output contains: LayoutCache hit rate, atlas utilization,
   upload time for async and sync modes
4. VERIFICATION.md contains profiling report with P29 recommendation
5. ROADMAP.md Phase 29 updated to reflect decision
</verification>

<success_criteria>
- stress_validation.v runs with 2000+ multilingual glyphs
- Profile metrics reported for both async and sync modes
- LayoutCache hit rate measured (PROF-01)
- Atlas utilization measured (PROF-02)
- Upload time async vs sync compared
- P29 decision documented with data-driven rationale
</success_criteria>

<output>
After completion, create
`.planning/phases/28-profiling-validation/28-01-SUMMARY.md`
</output>
