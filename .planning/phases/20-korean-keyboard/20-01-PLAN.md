---
phase: 20-korean-keyboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ime_overlay_darwin.m
  - ime_overlay_darwin.h
  - ime_overlay_stub.c
autonomous: true

must_haves:
  truths:
    - "Backspace during composition decomposes jamo (간 -> 가 -> ㄱ)"
    - "Focus loss auto-commits preedit text"
    - "Dead keys work immediately after using Korean IME"
  artifacts:
    - path: "ime_overlay_darwin.m"
      provides: "keyDown forwarding, resignFirstResponder cleanup"
      contains: "interpretKeyEvents"
    - path: "ime_overlay_darwin.m"
      provides: "IME state cleanup"
      contains: "invalidateCharacterCoordinates"
  key_links:
    - from: "keyDown:"
      to: "interpretKeyEvents:"
      via: "hasMarkedText check"
      pattern: "hasMarkedText.*interpretKeyEvents"
    - from: "resignFirstResponder"
      to: "invalidateCharacterCoordinates"
      via: "NSTextInputContext"
      pattern: "inputContext.*invalidateCharacterCoordinates"
---

<objective>
Native overlay key forwarding and focus management for Korean IME.

Purpose: Enable jamo backspace decomposition by forwarding keys to IME during composition,
and prevent dead key pollution by cleaning IME state on focus loss.

Output: ime_overlay_darwin.m with keyDown forwarding and focus cleanup.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-korean-keyboard/20-RESEARCH.md

@ime_overlay_darwin.m
@ime_overlay_darwin.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add keyDown forwarding to IME during composition</name>
  <files>ime_overlay_darwin.m</files>
  <action>
Add keyDown: method to VGlyphIMEOverlayView that forwards ALL keys to IME when composition is active:

```objc
- (void)keyDown:(NSEvent*)event {
    // When composing, forward ALL keys to IME for proper handling
    // This enables Korean jamo decomposition on backspace
    if ([self hasMarkedText]) {
        [self interpretKeyEvents:@[event]];
        return;
    }

    // Not composing: pass to next responder (MTKView/sokol)
    [self.nextResponder keyDown:event];
}
```

Also add doCommandBySelector: to forward IME commands:

```objc
- (void)doCommandBySelector:(SEL)selector {
    // Called by IME for non-character commands (arrows during composition, etc)
    // Forward to next responder for application handling
    if ([self.nextResponder respondsToSelector:selector]) {
        [self.nextResponder performSelector:selector withObject:nil];
    }
}
```

Why: Per RESEARCH.md, Korean IME requires receiving backspace via interpretKeyEvents to decompose
jamo correctly. Without this, app handles backspace as "delete char" which removes entire syllable.
  </action>
  <verify>clang -c -fobjc-arc ime_overlay_darwin.m -o /tmp/ime_test.o && echo "Compiles OK"</verify>
  <done>keyDown forwards to interpretKeyEvents when hasMarkedText, passes through when not composing</done>
</task>

<task type="auto">
  <name>Task 2: Add focus loss handling with IME state cleanup</name>
  <files>ime_overlay_darwin.m</files>
  <action>
Add becomeFirstResponder and resignFirstResponder overrides:

```objc
- (BOOL)becomeFirstResponder {
    BOOL result = [super becomeFirstResponder];
    if (result) {
        // Explicitly activate IME context to prevent first-character issues
        [[self inputContext] activate];
    }
    return result;
}

- (BOOL)resignFirstResponder {
    // Auto-commit any pending composition (per CONTEXT.md: focus loss = commit)
    if ([self hasMarkedText]) {
        [self unmarkText]; // Triggers insertText with preedit contents
    }

    // Critical: Clear IME state cache to prevent dead key pollution (RESEARCH.md Pitfall #2)
    [[self inputContext] invalidateCharacterCoordinates];

    return [super resignFirstResponder];
}
```

Also update vglyph_set_focused_field to call invalidateCharacterCoordinates on blur:

```objc
void vglyph_set_focused_field(VGlyphOverlayHandle handle, const char* field_id) {
    if (!handle) return;
    VGlyphIMEOverlayView* overlay = (__bridge VGlyphIMEOverlayView*)handle;

    if (field_id != NULL) {
        overlay.fieldId = [NSString stringWithUTF8String:field_id];
        [[overlay window] makeFirstResponder:overlay];
    } else {
        // Blur: commit and clean state
        if ([overlay hasMarkedText]) {
            [overlay unmarkText];
        }
        [[overlay inputContext] invalidateCharacterCoordinates];
        overlay.fieldId = nil;
        if (overlay.mtkView) {
            [[overlay window] makeFirstResponder:overlay.mtkView];
        }
    }
}
```

Why: Per RESEARCH.md Pitfall #2, NSTextInputContext caches IME state. Without explicit cleanup,
dead keys don't work after switching from Korean IME to US keyboard.
  </action>
  <verify>clang -c -fobjc-arc ime_overlay_darwin.m -o /tmp/ime_test.o && echo "Compiles OK"</verify>
  <done>Focus gain activates IME context, focus loss auto-commits and cleans state</done>
</task>

<task type="auto">
  <name>Task 3: Add cancelOperation for Escape key handling</name>
  <files>ime_overlay_darwin.m</files>
  <action>
Add cancelOperation: method for Escape key during composition:

```objc
- (void)cancelOperation:(id)sender {
    // Called when user presses Escape
    if ([self hasMarkedText]) {
        // Cancel composition without committing
        [self unmarkText];
        return;
    }

    // Not composing: forward to next responder
    [self.nextResponder cancelOperation:sender];
}
```

Why: Per CONTEXT.md research decision, Escape should cancel composition (not commit).
This matches Japanese IME behavior and user expectation for "undo current action".
  </action>
  <verify>clang -c -fobjc-arc ime_overlay_darwin.m -o /tmp/ime_test.o && echo "Compiles OK"</verify>
  <done>Escape cancels composition when hasMarkedText, forwards to app when not composing</done>
</task>

</tasks>

<verification>
1. Build verification:
   ```
   clang -c -fobjc-arc ime_overlay_darwin.m -o /tmp/ime_test.o
   ```
   Should compile without errors or warnings.

2. Code review checklist:
   - [ ] keyDown: checks hasMarkedText before forwarding
   - [ ] interpretKeyEvents called with event array
   - [ ] resignFirstResponder calls unmarkText if composing
   - [ ] resignFirstResponder calls invalidateCharacterCoordinates
   - [ ] becomeFirstResponder activates input context
   - [ ] cancelOperation handles Escape during composition
</verification>

<success_criteria>
- Objective-C compiles without errors
- keyDown forwards to interpretKeyEvents during composition
- Focus loss auto-commits via unmarkText
- IME state cleaned via invalidateCharacterCoordinates on blur
- Escape cancels composition via cancelOperation
</success_criteria>

<output>
After completion, create `.planning/phases/20-korean-keyboard/20-01-SUMMARY.md`
</output>
