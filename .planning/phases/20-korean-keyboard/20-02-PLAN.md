---
phase: 20-korean-keyboard
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - examples/editor_demo.v
autonomous: true

must_haves:
  truths:
    - "Undo/redo blocked during IME composition (Cmd+Z does nothing when composing)"
    - "Option+Backspace cancels composition first, then deletes word if not composing"
    - "Cmd+A during composition commits then selects all"
  artifacts:
    - path: "examples/editor_demo.v"
      provides: "Keyboard integration with composition state checks"
      contains: "composition.is_composing"
  key_links:
    - from: "editor_demo.v key_down"
      to: "composition.is_composing()"
      via: "guard checks before undo/redo"
      pattern: "composition.is_composing.*return"
---

<objective>
V-side keyboard integration for Korean IME edge cases.

Purpose: Block undo/redo during composition to prevent text duplication,
handle Option+Backspace and Cmd+A appropriately during composition.

Output: editor_demo.v with composition-aware keyboard handling.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-korean-keyboard/20-CONTEXT.md
@.planning/phases/20-korean-keyboard/20-RESEARCH.md

@examples/editor_demo.v
@composition.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Block undo/redo during IME composition</name>
  <files>examples/editor_demo.v</files>
  <action>
In the event handler, add composition check BEFORE undo/redo handling (around line 344-372):

Find the existing Cmd+Z handling:
```v
// Handle undo/redo FIRST - before other command handling
if cmd_held && e.key_code == .z && !shift_held {
    // Cmd+Z: undo
```

Add composition guard at the start of this block:
```v
// Handle undo/redo FIRST - before other command handling
if cmd_held && e.key_code == .z && !shift_held {
    // Block undo during IME composition (RESEARCH.md Pitfall #3)
    if state.composition.is_composing() {
        return // Silently ignore - don't undo during composition
    }
    // Cmd+Z: undo
    if new_text, new_cursor, new_anchor := state.undo_mgr.undo(...
```

Similarly for Cmd+Shift+Z redo:
```v
if cmd_held && e.key_code == .z && shift_held {
    // Block redo during IME composition
    if state.composition.is_composing() {
        return
    }
    // Cmd+Shift+Z: redo
    if new_text, new_cursor, new_anchor := state.undo_mgr.redo(...
```

Why: Per RESEARCH.md Pitfall #3, undo during composition causes text duplication or state
corruption. Standard macOS apps (TextEdit, Safari) block Cmd+Z when hasMarkedText is true.
  </action>
  <verify>v -check-syntax examples/editor_demo.v</verify>
  <done>Cmd+Z and Cmd+Shift+Z return early when composition.is_composing()</done>
</task>

<task type="auto">
  <name>Task 2: Handle Option+Backspace during composition</name>
  <files>examples/editor_demo.v</files>
  <action>
In the backspace handling block (around line 636-686), add composition-first logic for
Option+Backspace per CONTEXT.md user decision:

Find the existing backspace handling:
```v
.backspace {
    // opt_held already defined above for arrow key handling
    ...
```

Add Option+Backspace composition handling at the START of this block:
```v
.backspace {
    // Per CONTEXT.md: Option+Backspace cancels composition first, then deletes word
    if opt_held && state.composition.is_composing() {
        state.composition.cancel()
        // Rebuild layout without preedit
        state.layout = state.ts.layout_text(state.text, state.cfg) or { return }
        return // Don't proceed to word deletion this keypress
    }

    // Regular backspace during composition is handled by IME (line 310-317)
    // This block only reached when NOT composing

    // Capture cursor state BEFORE mutation for undo
    cursor_before := state.cursor_idx
    ...
```

Note: Regular backspace during composition is already blocked at line 310-317 and forwarded
to the native IME via the overlay's keyDown handler. This change only adds special
Option+Backspace behavior: cancel composition, don't delete word on same keypress.
  </action>
  <verify>v -check-syntax examples/editor_demo.v</verify>
  <done>Option+Backspace cancels composition first, returns without deleting word</done>
</task>

<task type="auto">
  <name>Task 3: Handle Cmd+A during composition (commit then select)</name>
  <files>examples/editor_demo.v</files>
  <action>
In the Cmd+A handling (around line 378-390), add composition commit per RESEARCH.md Q5:

Find the existing Cmd+A block:
```v
.a {
    // Cmd+A: select all
    state.anchor_idx = 0
```

Add commit-then-select logic:
```v
.a {
    // Per RESEARCH.md: Cmd+A during composition commits first, then selects
    if state.composition.is_composing() {
        committed := state.composition.commit()
        if committed.len > 0 {
            cursor_before := state.cursor_idx
            anchor_before := state.anchor_idx
            result := vglyph.insert_text(state.text, state.cursor_idx, committed)
            new_layout := state.ts.layout_text(result.new_text, state.cfg) or {
                state.skip_char_event = true
                return
            }
            mut new_cursor := result.cursor_pos
            if new_cursor < 0 { new_cursor = 0 }
            if new_cursor > result.new_text.len { new_cursor = result.new_text.len }
            state.text = result.new_text
            state.layout = new_layout
            state.cursor_idx = new_cursor
            state.undo_mgr.record_mutation(result, committed, cursor_before, anchor_before)
        }
    }
    // Cmd+A: select all
    state.anchor_idx = 0
    positions := state.layout.get_valid_cursor_positions()
    state.cursor_idx = if positions.len > 0 {
        positions[positions.len - 1]
    } else { 0 }
    state.has_selection = state.anchor_idx != state.cursor_idx
    state.skip_char_event = true
    return
}
```

Why: Per RESEARCH.md Q5, Cmd+A is "select all" not a composition command. IME implicitly
commits, then selection happens. Less surprising than blocking the command entirely.
  </action>
  <verify>v -check-syntax examples/editor_demo.v</verify>
  <done>Cmd+A commits composition first, then selects all text</done>
</task>

</tasks>

<verification>
1. Syntax verification:
   ```
   v -check-syntax examples/editor_demo.v
   ```
   Should pass without errors.

2. Build verification:
   ```
   v examples/editor_demo.v -o /tmp/editor_test
   ```
   Should compile successfully.

3. Code review checklist:
   - [ ] Cmd+Z returns early when composition.is_composing()
   - [ ] Cmd+Shift+Z returns early when composition.is_composing()
   - [ ] Option+Backspace cancels composition, returns without word delete
   - [ ] Cmd+A commits composition before selecting all
</verification>

<success_criteria>
- V syntax check passes
- Demo builds successfully
- Undo/redo blocked during composition
- Option+Backspace cancels composition without word deletion
- Cmd+A commits then selects all
</success_criteria>

<output>
After completion, create `.planning/phases/20-korean-keyboard/20-02-SUMMARY.md`
</output>
