---
phase: 19-nstextinputclient-jpch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ime_overlay_darwin.h
  - ime_overlay_darwin.m
  - ime_overlay_stub.c
  - c_bindings.v
autonomous: true

must_haves:
  truths:
    - "setMarkedText invokes on_marked_text callback with preedit text and cursor position"
    - "insertText invokes on_insert_text callback with committed text"
    - "unmarkText invokes on_unmark_text callback and resets markedRange"
    - "hasMarkedText returns true when _markedRange.location != NSNotFound"
    - "markedRange returns current _markedRange tracking state"
  artifacts:
    - path: "ime_overlay_darwin.m"
      provides: "NSTextInputClient core method implementations"
      contains: "vglyph_ime_set_marked_text"
    - path: "ime_overlay_darwin.h"
      provides: "C API declarations for IME events"
      contains: "VGlyphIMECallbacks"
    - path: "c_bindings.v"
      provides: "V wrappers for IME callback registration"
      contains: "ime_overlay_register_callbacks"
  key_links:
    - from: "ime_overlay_darwin.m"
      to: "VGlyphIMECallbacks"
      via: "function pointer invocation"
      pattern: "callbacks\\.on_marked_text"
---

<objective>
Implement NSTextInputClient core methods in overlay to bridge IME events to V callbacks.

Purpose: Enable Japanese/Chinese IME to communicate preedit/commit/cancel via C callbacks.
Output: Working setMarkedText/insertText/unmarkText that invoke registered callback functions.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-nstextinputclient-jpch/19-CONTEXT.md
@.planning/phases/19-nstextinputclient-jpch/19-RESEARCH.md
@.planning/phases/18-overlay-infrastructure/18-01-SUMMARY.md

@ime_overlay_darwin.h
@ime_overlay_darwin.m
@c_bindings.v
@composition.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: C API and callback structure for IME events</name>
  <files>ime_overlay_darwin.h, ime_overlay_darwin.m, ime_overlay_stub.c</files>
  <action>
Add callback structure and registration function to ime_overlay_darwin.h:

```c
// Callback structure for IME events
typedef struct {
    void (*on_marked_text)(const char* text, int cursor_pos, void* user_data);
    void (*on_insert_text)(const char* text, void* user_data);
    void (*on_unmark_text)(void* user_data);
    void* user_data;
} VGlyphIMECallbacks;

// Register callbacks for IME events
void vglyph_overlay_register_callbacks(VGlyphOverlayHandle handle, VGlyphIMECallbacks callbacks);
```

In ime_overlay_darwin.m:
1. Add `VGlyphIMECallbacks callbacks` property to VGlyphIMEOverlayView
2. Add `NSRange _markedRange` and `NSRange _selectedRange` ivars to track state
3. Implement `vglyph_overlay_register_callbacks` to store callbacks in overlay

In ime_overlay_stub.c, add stub for `vglyph_overlay_register_callbacks` (no-op).

Rationale: Need explicit callback registration per-overlay (not global) because app may have
multiple text fields.
  </action>
  <verify>
`clang -fsyntax-only -fobjc-arc -framework Cocoa ime_overlay_darwin.m` compiles
`clang -fsyntax-only ime_overlay_stub.c` compiles
grep finds `VGlyphIMECallbacks` in header
  </verify>
  <done>
Callback struct defined, registration function exists in both Darwin and stub
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement setMarkedText and query methods</name>
  <files>ime_overlay_darwin.m</files>
  <action>
Implement NSTextInputClient methods in VGlyphIMEOverlayView:

1. `setMarkedText:selectedRange:replacementRange:`:
   - Extract text from id (handle both NSString and NSAttributedString)
   - Handle replacementRange edge cases per RESEARCH.md Pitfall #1:
     - If NSNotFound, use current markedRange; if that's NSNotFound, use selectedRange
   - Update _markedRange to (replacementRange.location, text.length)
   - Update _selectedRange to (replacementRange.location + selectedRange.location, 0)
   - Call `callbacks.on_marked_text([text UTF8String], selectedRange.location, user_data)`

2. `markedRange`: Return _markedRange (NSMakeRange(NSNotFound, 0) if not composing)

3. `selectedRange`: Return _selectedRange

4. `hasMarkedText`: Return `_markedRange.location != NSNotFound`

5. Initialize ivars in init or property defaults:
   - `_markedRange = NSMakeRange(NSNotFound, 0)`
   - `_selectedRange = NSMakeRange(0, 0)`

Per CONTEXT.md: cursor_in_preedit is selectedRange.location (byte offset within preedit).
  </action>
  <verify>
grep finds `on_marked_text` call in setMarkedText implementation
grep finds `_markedRange.location != NSNotFound` in hasMarkedText
`v -check-syntax c_bindings.v` passes (no V changes yet, just verify no breakage)
  </verify>
  <done>
setMarkedText invokes on_marked_text callback, markedRange/selectedRange/hasMarkedText return
correct state
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement insertText and unmarkText, V bindings</name>
  <files>ime_overlay_darwin.m, c_bindings.v</files>
  <action>
In ime_overlay_darwin.m:

1. `insertText:replacementRange:`:
   - Extract text from id (handle NSString and NSAttributedString)
   - Call `callbacks.on_insert_text([text UTF8String], user_data)`
   - Call `[self unmarkText]` to clear composition state

2. `unmarkText`:
   - Reset `_markedRange = NSMakeRange(NSNotFound, 0)`
   - Call `callbacks.on_unmark_text(user_data)` if callbacks set

In c_bindings.v, add V wrapper:

```v
// Callback types for IME overlay events
type IMEOverlayMarkedTextCallback = fn (text &char, cursor_pos int, user_data voidptr)
type IMEOverlayInsertTextCallback = fn (text &char, user_data voidptr)
type IMEOverlayUnmarkTextCallback = fn (user_data voidptr)

// C function declaration
fn C.vglyph_overlay_register_callbacks(handle voidptr, callbacks C.VGlyphIMECallbacks)

// V wrapper
pub fn ime_overlay_register_callbacks(handle voidptr, on_marked IMEOverlayMarkedTextCallback,
    on_insert IMEOverlayInsertTextCallback, on_unmark IMEOverlayUnmarkTextCallback,
    user_data voidptr) {
    callbacks := C.VGlyphIMECallbacks{
        on_marked_text: on_marked
        on_insert_text: on_insert
        on_unmark_text: on_unmark
        user_data: user_data
    }
    C.vglyph_overlay_register_callbacks(handle, callbacks)
}
```

Also add C.VGlyphIMECallbacks typedef struct to c_bindings.v matching the C header.
  </action>
  <verify>
`v -check-syntax c_bindings.v` passes
grep finds `on_insert_text` call in insertText implementation
grep finds `unmarkText` clearing _markedRange
  </verify>
  <done>
insertText invokes on_insert_text callback, unmarkText invokes on_unmark_text and resets state,
V bindings expose callback registration
  </done>
</task>

</tasks>

<verification>
1. Build verification:
   - `clang -c -fobjc-arc -framework Cocoa ime_overlay_darwin.m -o /dev/null`
   - `v -check-syntax c_bindings.v`

2. Protocol compliance:
   - All 9 NSTextInputClient methods implemented (no longer stubs)
   - Callback invocations present for marked/insert/unmark

3. State tracking:
   - _markedRange and _selectedRange properly maintained
   - hasMarkedText returns correct boolean based on _markedRange
</verification>

<success_criteria>
- setMarkedText extracts text and invokes on_marked_text callback
- insertText extracts text, invokes on_insert_text, calls unmarkText
- unmarkText resets _markedRange, invokes on_unmark_text
- hasMarkedText returns true during composition
- markedRange/selectedRange return tracked state
- V bindings compile and expose callback registration
</success_criteria>

<output>
After completion, create `.planning/phases/19-nstextinputclient-jpch/19-01-SUMMARY.md`
</output>
