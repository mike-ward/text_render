---
phase: 03-layout-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [layout.v, layout_types.v]
autonomous: true

must_haves:
  truths:
    - "Pointer cast at line 156 has documentation explaining safety assumption"
    - "Debug builds validate the pointer cast at runtime"
    - "Inline object IDs are cloned before passing to Pango"
    - "Cloned strings are freed when Layout is destroyed"
  artifacts:
    - path: "layout.v"
      provides: "Pointer documentation, debug validation, string cloning"
      contains: "PangoLayoutRun is a typedef for PangoGlyphItem"
    - path: "layout_types.v"
      provides: "Layout struct with cloned_object_ids field and free method"
      contains: "cloned_object_ids"
  key_links:
    - from: "layout.v:apply_rich_text_style"
      to: "Layout.cloned_object_ids"
      via: "clone and append"
      pattern: "cloned_object_ids.*clone"
    - from: "layout_types.v:Layout.free"
      to: "cloned_object_ids"
      via: "iterate and free"
      pattern: "free.*str"
---

<objective>
Document unsafe pointer cast and fix string lifetime for inline object IDs in layout system.

Purpose: Prevent undefined behavior from undocumented assumptions and use-after-free in C FFI
Output: Safe, documented layout code with proper string lifetime management
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-layout-safety/03-CONTEXT.md
@.planning/phases/03-layout-safety/03-RESEARCH.md
@layout.v
@layout_types.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document pointer cast and add debug validation</name>
  <files>layout.v</files>
  <action>
At line 153-156 in build_layout_from_pango where the pointer cast happens:

1. Add brief inline comment (1-2 lines) above the cast explaining:
   - PangoLayoutRun is a typedef for PangoGlyphItem (safe to cast)
   - Reference: https://docs.gtk.org/Pango/struct.LayoutRun.html

2. Add $if debug block after the cast with:
   - Null check on run pointer
   - Panic with simple message if null (not assert, per user decision)

Example structure:
```v
// PangoLayoutRun is a typedef for PangoGlyphItem - cast is safe per Pango API
// See: https://docs.gtk.org/Pango/struct.LayoutRun.html
run := unsafe { &C.PangoLayoutRun(run_ptr) }
$if debug {
    if voidptr(run) == unsafe { nil } {
        panic('PangoLayoutRun cast returned nil')
    }
}
```
  </action>
  <verify>v -check-syntax layout.v</verify>
  <done>Pointer cast has documentation comment and debug validation with panic</done>
</task>

<task type="auto">
  <name>Task 2: Fix string lifetime for inline object IDs</name>
  <files>layout.v, layout_types.v</files>
  <action>
Part A - Add tracking field to Layout struct (layout_types.v):
1. Add `cloned_object_ids []string` field to Layout struct in pub mut section
2. Add Layout.free() method that iterates cloned_object_ids and frees each string:

```v
pub fn (mut l Layout) free() {
    for s in l.cloned_object_ids {
        if s.len > 0 {
            unsafe { free(s.str) }
        }
    }
    l.cloned_object_ids = []
}
```

Part B - Clone strings in apply_rich_text_style (layout.v):
1. In apply_rich_text_style around line 961-962, before passing obj.id.str to Pango:
   - Skip cloning if obj.id is empty (per user decision)
   - Clone the string: `cloned_id := obj.id.clone()`
   - Use cloned_id.str as data_ptr

2. Problem: apply_rich_text_style doesn't have access to Layout to track the clone.
   Solution: The cloning must happen in build_layout_from_pango which creates the Layout.

   Actually, looking at the code flow:
   - apply_rich_text_style is called during layout creation
   - It sets shape_attr.data = obj.id.str
   - The Layout is returned after all processing

   Better approach: Track in a local array during layout creation, then assign to Layout.

   In build_layout_from_pango (around line 104):
   - Add `mut cloned_ids := []string{}`
   - This needs to be passed through to apply_rich_text_style or handled differently

   Simplest fix: In apply_rich_text_style, clone the string and the caller (layout_rich_text
   or layout_text) must track it. But apply_rich_text_style is a helper that doesn't return
   values.

   Pragmatic solution: Clone in apply_rich_text_style and accept the tracking happens at
   Layout level. Pass a mutable reference to the tracking array.

   Update apply_rich_text_style signature to accept `mut cloned_ids []string`:
   - Clone obj.id if not empty
   - Append to cloned_ids
   - Use cloned string's .str pointer

3. Update callers of apply_rich_text_style in layout_rich_text (line 93) to pass the array.

4. In build_layout_from_pango return, include cloned_object_ids in Layout construction.
   Note: build_layout_from_pango doesn't call apply_rich_text_style directly.
   The flow is: layout_rich_text -> apply_rich_text_style -> build_layout_from_pango

   Need to thread cloned_ids through the call chain or use a different approach.

Final approach (cleanest):
- build_layout_from_pango doesn't need changes (no inline objects there)
- apply_rich_text_style gets `mut cloned_ids &[]string` parameter
- layout_rich_text creates the array, passes to apply_rich_text_style, sets on Layout
- layout_text doesn't use apply_rich_text_style for inline objects, so no change needed
  </action>
  <verify>v -check-syntax layout.v && v -check-syntax layout_types.v</verify>
  <done>Object IDs cloned before Pango, Layout.free() frees cloned strings</done>
</task>

</tasks>

<verification>
- v -check-syntax layout.v
- v -check-syntax layout_types.v
- Comment exists above pointer cast at line ~156
- $if debug block exists after cast
- Layout struct has cloned_object_ids field
- Layout.free() method exists and frees strings
- apply_rich_text_style clones obj.id when not empty
</verification>

<success_criteria>
1. Pointer cast documented with Pango reference URL
2. Debug builds panic if cast returns nil
3. Inline object IDs cloned before passing to Pango
4. Layout.free() properly frees all cloned strings
5. Code compiles with v -check-syntax
</success_criteria>

<output>
After completion, create `.planning/phases/03-layout-safety/03-01-SUMMARY.md`
</output>
