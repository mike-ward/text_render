---
phase: 21-multi-display-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ime_bridge_macos.m
autonomous: true

must_haves:
  truths:
    - "Candidate window appears on correct monitor when window on external display"
    - "Coordinate transforms work on Retina displays without 2x offset"
    - "Candidate position updates after dragging window between monitors"
  artifacts:
    - path: "ime_bridge_macos.m"
      provides: "firstRectForCharacterRange with correct screen detection"
      contains: "convertRectToScreen"
  key_links:
    - from: "ime_bridge_macos.m"
      to: "NSWindow.convertRectToScreen"
      via: "coordinate transform chain"
      pattern: "convertRectToScreen"
---

<objective>
Fix multi-monitor coordinate handling in ime_bridge_macos.m

Purpose: Candidate window currently jumps to primary monitor when window on external display
because code uses [[NSScreen screens] firstObject] instead of window's actual screen.

Output: Correct firstRectForCharacterRange implementation using convertRectToScreen
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-multi-display-polish/21-RESEARCH.md

@ime_bridge_macos.m
@ime_overlay_darwin.m
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix firstRectForCharacterRange in ime_bridge_macos.m</name>
  <files>ime_bridge_macos.m</files>
  <action>
Replace the manual screen coordinate calculation in firstRectForCharacterRange with the correct
pattern from RESEARCH.md:

Current code (WRONG - lines 312-337):
- Uses [[NSScreen screens] firstObject] - always returns primary screen
- Manual coordinate arithmetic with screen_height

Replace with:
```objc
- (NSRect)firstRectForCharacterRange:(NSRange)range actualRange:(nullable NSRangePointer)actualRange {
    // Query V for composition bounds
    if (g_bounds_callback) {
        float x = 0, y = 0, width = 0, height = 0;
        if (g_bounds_callback(g_user_data, &x, &y, &width, &height)) {
            // Flip Y: VGlyph top-left origin -> macOS bottom-left origin
            NSRect viewRect = NSMakeRect(x, self.bounds.size.height - y - height, width, height);

            // Transform: view -> window -> screen (handles Retina + multi-monitor automatically)
            NSRect windowRect = [self convertRect:viewRect toView:nil];
            NSRect screenRect = [[self window] convertRectToScreen:windowRect];

            return screenRect;
        }
    }

    // Fallback: return zero rect (IME will use default position)
    return NSZeroRect;
}
```

Key changes:
1. Remove [[NSScreen screens] firstObject] - don't reference primary screen at all
2. Use self.bounds.size.height for Y-flip (view's own bounds, not screen)
3. Use convertRect:toView:nil then convertRectToScreen: (two-step transform)
4. Remove manual windowFrame arithmetic
5. Return NSZeroRect on failure (not hardcoded fallback position)

Do NOT change any other methods in the file.
  </action>
  <verify>
1. Build: `v examples/editor_demo.v` compiles without errors
2. Code review: grep -n "firstObject" ime_bridge_macos.m should return nothing
3. Code review: grep -n "convertRectToScreen" ime_bridge_macos.m should return 1 match
  </verify>
  <done>
firstRectForCharacterRange uses convertRectToScreen pattern, no reference to [[NSScreen screens]
firstObject]
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify ime_overlay_darwin.m uses correct pattern</name>
  <files>ime_overlay_darwin.m</files>
  <action>
Verify ime_overlay_darwin.m already uses the correct coordinate pattern.

Check firstRectForCharacterRange (around line 148-180):
- Should already use convertRect:toView:nil then convertRectToScreen:
- Should NOT reference [[NSScreen screens] firstObject]

If correct (expected based on Phase 19 implementation): No changes needed.

If incorrect: Apply same fix as Task 1.

Document verification in commit message regardless of whether changes made.
  </action>
  <verify>
1. grep -n "firstObject" ime_overlay_darwin.m should return nothing
2. grep -n "convertRectToScreen" ime_overlay_darwin.m should return 1 match
  </verify>
  <done>
Both IME bridge files use correct convertRectToScreen pattern for multi-monitor support
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `v examples/editor_demo.v` builds without errors
2. Neither file references [[NSScreen screens] firstObject] for coordinate calculations
3. Both files use convertRectToScreen for screen coordinate transforms
</verification>

<success_criteria>
- ime_bridge_macos.m uses convertRectToScreen (not manual screen arithmetic)
- ime_overlay_darwin.m verified to use correct pattern
- No [[NSScreen screens] firstObject] usage in coordinate code
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/21-multi-display-polish/21-01-SUMMARY.md`
</output>
