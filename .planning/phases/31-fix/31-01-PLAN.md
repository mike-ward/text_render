---
phase: 31-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [glyph_atlas.v]
autonomous: false

must_haves:
  truths:
    - "stress_demo scrolls smoothly without visible flickering"
    - "stress_demo renders text without perceptible delays"
    - "stress_demo shows no blank regions during or after scrolling"
    - "v test passes with zero failures"
  artifacts:
    - path: "glyph_atlas.v"
      provides: "vmemcpy staging_frontâ†’staging_back after swap"
      contains: "vmemcpy(page.staging_back.data, page.staging_front.data"
  key_links:
    - from: "glyph_atlas.v swap_staging_buffers()"
      to: "staging_back.data"
      via: "vmemcpy after pointer swap"
      pattern: "vmemcpy\\(page\\.staging_back\\.data.*page\\.staging_front\\.data"
---

<objective>
Fix all three v1.6 regression symptoms (flickering, delays, blank
regions) by adding vmemcpy after double-buffer swap in
swap_staging_buffers().

Purpose: Preserve accumulated glyph data when staging buffers swap,
preventing data loss that causes glyphs to alternate visible/invisible.

Output: Fixed glyph_atlas.v with passing tests, ready for user
validation.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-fix/31-CONTEXT.md
@.planning/phases/31-fix/31-RESEARCH.md
@.planning/phases/30-diagnosis/30-02-SUMMARY.md
@glyph_atlas.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vmemcpy after buffer swap</name>
  <files>glyph_atlas.v</files>
  <action>
In swap_staging_buffers() (line ~763), add vmemcpy AFTER the existing
pointer swap (lines 772-774) and BEFORE the post-swap diagnostic block
(line 775).

Insert these 3 lines after `page.staging_back = tmp`:

```v
	// Preserve accumulated glyph data for next frame's CPU writes
	unsafe {
		vmemcpy(page.staging_back.data, page.staging_front.data, page.staging_front.len)
	}
```

Parameter order is critical (dest, src, n):
- dest = page.staging_back.data (receives copy)
- src = page.staging_front.data (has accumulated data)
- n = page.staging_front.len (byte count)

Also update the post-swap diag warning (line ~783) from:
`'[DIAG] WARNING: Buffers identical after swap - possible data loss'`
to:
`'[DIAG] POST-SWAP: Buffers identical after copy - expected behavior'`

Do NOT modify the sync path in renderer.v.
Do NOT modify any other function.

Format with `v fmt -w glyph_atlas.v` after editing.
  </action>
  <verify>
`v -check-syntax glyph_atlas.v` succeeds.
`v fmt -verify glyph_atlas.v` succeeds (already formatted).
grep confirms vmemcpy line exists in swap_staging_buffers.
  </verify>
  <done>
swap_staging_buffers() contains vmemcpy(page.staging_back.data,
page.staging_front.data, page.staging_front.len) inside unsafe block
after the pointer swap. Diag warning updated. File compiles and is
formatted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run test suite</name>
  <files></files>
  <action>
Run `v test .` from the project root directory. All tests must pass
with zero failures. This is a gate -- if tests fail, diagnose and fix
before proceeding to user validation.

Do NOT modify test files. If a test fails, the fix in Task 1 has a
bug that needs correcting.
  </action>
  <verify>`v test .` exits with 0 failures.</verify>
  <done>All existing tests pass. No regressions from the vmemcpy fix.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Applied vmemcpy fix to swap_staging_buffers() in glyph_atlas.v.
After each buffer swap, staging_front data is copied to staging_back
so accumulated glyph data persists across frames. All tests pass.
  </what-built>
  <how-to-verify>
1. Build and run stress_demo: `v run examples/stress_demo.v`
2. Scroll up and down continuously for 10+ seconds
3. Resize the window while scrolling
4. Verify: no flickering, no blank regions, no rendering delays
5. Compare against the symptoms you saw before the fix
  </how-to-verify>
  <resume-signal>
- "approved" if all 3 symptoms are resolved
- describe remaining symptoms if ANY persist (triggers full Phase 27
  revert per your decision: no partial fixes, no alternate approaches)
  </resume-signal>
  <fallback>
If ANY symptom persists, execute full Phase 27 revert:
1. `git revert 2a63170 --no-edit` (async commit with swap+upload)
2. `git revert 9febd3d --no-edit` (staging buffers)
3. Remove Phase 30 diag code referencing async paths (dead code)
4. Run `v test .` to confirm revert is clean
5. Return to user for re-validation
  </fallback>
</task>

</tasks>

<verification>
- `v -check-syntax glyph_atlas.v` passes
- `v test .` passes with zero failures
- grep for vmemcpy in swap_staging_buffers confirms fix present
- User validates stress_demo visually (checkpoint)
</verification>

<success_criteria>
- swap_staging_buffers() preserves accumulated data via vmemcpy
- All existing tests pass
- User confirms stress_demo has no flickering, delays, or blank regions
- OR: Phase 27 fully reverted with documented rationale if fix failed
</success_criteria>

<output>
After completion, create
`.planning/phases/31-fix/31-01-SUMMARY.md`
</output>
