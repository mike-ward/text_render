---
phase: 01-error-propagation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/glyph_atlas.v
  - src/renderer.v
autonomous: true

must_haves:
  truths:
    - "new_glyph_atlas returns error on invalid dimensions (0, negative)"
    - "new_glyph_atlas returns error on size overflow"
    - "new_glyph_atlas returns error on allocation failure"
    - "All callers handle GlyphAtlas error with or blocks"
    - "Code compiles without syntax errors"
  artifacts:
    - path: "glyph_atlas.v"
      provides: "Error-returning GlyphAtlas constructor"
      contains: "!GlyphAtlas"
    - path: "renderer.v"
      provides: "Callers with error handling"
      contains: "or { panic(err) }"
  key_links:
    - from: "renderer.v:new_renderer"
      to: "glyph_atlas.v:new_glyph_atlas"
      via: "Result type consumption with or block"
      pattern: "new_glyph_atlas.*or.*panic"
    - from: "renderer.v:new_renderer_atlas_size"
      to: "glyph_atlas.v:new_glyph_atlas"
      via: "Result type consumption with or block"
      pattern: "new_glyph_atlas.*or.*panic"
---

<objective>
Convert new_glyph_atlas from assert-based validation to error-returning API.

Purpose: Prevent crashes from invalid inputs by returning errors callers can handle.
Output: GlyphAtlas constructor returns `!GlyphAtlas`, callers use `or` blocks.
</objective>

<execution_context>
@/Users/mike/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mike/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-error-propagation/01-RESEARCH.md
@glyph_atlas.v
@renderer.v
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert new_glyph_atlas to return Result type</name>
  <files>glyph_atlas.v</files>
  <action>
1. Change function signature at line 47:
   FROM: `fn new_glyph_atlas(mut ctx gg.Context, w int, h int) GlyphAtlas`
   TO: `fn new_glyph_atlas(mut ctx gg.Context, w int, h int) !GlyphAtlas`

2. Replace assert at line 49 with error return:
   FROM: `assert w > 0 && h > 0, 'Atlas dimensions must be positive: ${w}x${h}'`
   TO:
   ```v
   if w <= 0 || h <= 0 {
       return error('Atlas dimensions must be positive: ${w}x${h}')
   }
   ```

3. Replace assert at line 53 with error return:
   FROM: `assert size > 0 && size <= max_i32, 'Atlas size overflow: ${w}x${h} = ${size} bytes'`
   TO:
   ```v
   if size <= 0 || size > max_i32 {
       return error('Atlas size overflow: ${w}x${h} = ${size} bytes')
   }
   ```

4. Replace assert at line 73 with error return:
   FROM: `assert img.data != unsafe { nil }, 'Failed to allocate atlas memory: ${size} bytes'`
   TO:
   ```v
   if img.data == unsafe { nil } {
       return error('Failed to allocate atlas memory: ${size} bytes')
   }
   ```

Note: Follow existing codebase pattern from context.v:new_context which returns !&Context.
  </action>
  <verify>v -check-syntax glyph_atlas.v</verify>
  <done>new_glyph_atlas returns !GlyphAtlas, all asserts replaced with error returns</done>
</task>

<task type="auto">
  <name>Task 2: Update callers to handle GlyphAtlas error</name>
  <files>renderer.v</files>
  <action>
1. Update new_renderer at line 27:
   FROM: `mut atlas := new_glyph_atlas(mut ctx, 1024, 1024)`
   TO: `mut atlas := new_glyph_atlas(mut ctx, 1024, 1024) or { panic(err) }`

2. Update new_renderer_atlas_size at line 40:
   FROM: `mut atlas := new_glyph_atlas(mut ctx, width, height)`
   TO: `mut atlas := new_glyph_atlas(mut ctx, width, height) or { panic(err) }`

Using `or { panic(err) }` is correct here because:
- These are constructor functions (initialization code)
- Atlas creation failure is unrecoverable for the renderer
- Matches existing pattern in examples/api_demo.v line 35

Note: Do NOT propagate error (no `!` suffix on new_renderer return type). Renderer
constructors should remain simple - atlas failure = fatal.
  </action>
  <verify>v -check-syntax renderer.v && v -check-syntax glyph_atlas.v</verify>
  <done>Both callers handle error with or { panic(err) }, code compiles</done>
</task>

</tasks>

<verification>
```bash
# Syntax check both files
v -check-syntax glyph_atlas.v
v -check-syntax renderer.v

# Full project build (optional but recommended)
v .

# Format check
v fmt -w glyph_atlas.v
v fmt -w renderer.v
```
</verification>

<success_criteria>
1. new_glyph_atlas signature is `fn new_glyph_atlas(...) !GlyphAtlas`
2. Zero assert statements remain in new_glyph_atlas function
3. Three error returns exist: dimensions check, overflow check, allocation check
4. new_renderer has `or { panic(err) }` on atlas creation
5. new_renderer_atlas_size has `or { panic(err) }` on atlas creation
6. `v -check-syntax` passes for both files
</success_criteria>

<output>
After completion, create `.planning/phases/01-error-propagation/01-01-SUMMARY.md`
</output>
